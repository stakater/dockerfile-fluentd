<source>
  @type tail
  path /var/lib/docker/containers/*.log
  pos_file /var/log/es-containers.log.pos
  time_format %Y-%m-%dT%H:%M:%S.%N
  tag docker.*
  format json
  read_from_head true
  keep_time_key true
</source>

<filter docker.**>
  @type parser
  format json # apache2, nginx, etc...
  key_name log
  reserve_data true
</filter>

<filter docker.**>
  @type concat
  key log
  stream_identity_key container_id
  multiline_start_regexp /^{"log":"\\u001b\[/
</filter>

<match **>
  @type elasticsearch
  @log_level info
  include_tag_key true
  host "#{ENV['ES_HOST']}"
  port "#{ENV['ES_PORT']}"
  logstash_format true
  flush_interval 5s
  # Never wait longer than 5 minutes between retries.
  max_retry_wait 60
  # Disable the limit on the number of retries (retry forever).
  disable_retry_limit
  time_key time
  reload_connections false
</match>
